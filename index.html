<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Unightly Club Hangout</title>
  <link rel="icon" href="https://raw.githubusercontent.com/silentmason/Unightly-Club-Hangout/refs/heads/main/UCHimage.webp" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Unightly Club Hangout</h1>
    <nav>
      <a href="#">Home</a>
      <a href="#">About</a>
      <a href="#">Contact</a>
    </nav>
  </header>
  <div class="content">
    <div id="loading">
      Loading posts...
    </div>
    <div id="posts-container" style="display: none;"></div>
  </div>
  <footer>
    <a href="https://unightly-club-hangout.github.io/uch/terms_of_service.html">Terms of Service</a>
    <a href="https://unightly-club-hangout.github.io/uch/privacy_policy.html">Privacy Policy</a>
    <a href="https://unightly-club-hangout.github.io/uch/issue.html">System Status</a>
  </footer>
  <div class="discord-widget">
    <iframe src="https://discord.com/widget?id=1401631295108546590&theme=dark" width="350" height="500" allowtransparency="true" frameborder="0" ></iframe>
  </div>
  <script>
  let previousPosts = [];
  let previousTitles = []; // Track previous post titles
let previousLength = 0; // Keep track of the previous data length

  const googleSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTWHMfgoHQ33CDC9H30UMh67iQBpcBXv1s1cLH8-FQfZkW_VUsq2O0npXFmxBV7j9xkk16wWQo4tP29/pub?output=csv"; // Replace with your Google Sheet URL
  const discordWebhookUrl = "https://discord.com/api/webhooks/1413564287489671350/b-vIZS-1RaWHvSye5q0Bv-zW_0s5kDoZaYTt_KRe4QR7L77tGV5fX9DVeEiiynfARgNH"; // Replace with your Discord Webhook URL

  fetch(googleSheetUrl)
    .then(response => response.text())
    .then(csvData => {
      const posts = parseCSV(csvData);
      displayPosts(posts);
    previousPosts = posts;

    previousTitles = posts.map(post => post.Title);
    previousLength = csvData.length;
    })
    .catch(error => console.error("Error fetching data:", error));

  function parseCSV(csvData) {
    const lines = csvData.split("\n");
    const headers = lines[0].split(",").map(header => header.trim());
    const posts = [];

    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(",").map(value => value.trim());
      if (values.length === headers.length) {
        const post = {};
        for (let j = 0; j < headers.length; j++) {
        post[headers[j]] = values[j];
        }
        posts.push(post);
      }
    }
    return posts;
  }

  function displayPosts(posts) {
    const postsContainer = document.getElementById("posts-container");
    postsContainer.innerHTML = "";
  document.getElementById('loading').style.display = 'none';
  document.getElementById('posts-container').style.display = 'block';
  posts.forEach(post => {
    const postDiv = document.createElement("div");
    postDiv.innerHTML = `
          <h2>${post.Title}</h2>
          <p>${post.Content}</p>
          ${post.ImageURL ? `<img src="${post.ImageURL}" alt="${post.Title}">` : ""}
        `;
    postsContainer.appendChild(postDiv);
  });
  }

  async function sendToDiscord(post) {
    const webhookUrl = discordWebhookUrl;

    // Check if the content ends with 'X' or 'Y'
    const content = post.Content.trim();
    if (content.endsWith("X")) {
        console.log("Discord post disabled for this message.");
        return; // Prevent sending the webhook
    }

    const message = {
      embeds: [{
        title: post.Title,
        description: post.Content,
        image: post.ImageURL ? { url: post.ImageURL } : null
      }]
    };

    try {
      await fetch(webhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(message)
      });
      console.log('Post sent to Discord!');
    } catch (error) {
      console.error('Error sending to Discord:', error);
    }
  }

  async function checkForNewPosts() {
    try {
      const response = await fetch(googleSheetUrl);
      const csvData = await response.text();
      const posts = parseCSV(csvData);

        if (csvData.length !== previousLength) {
        const newestPost = posts[0];

        await sendToDiscord(newestPost);

        previousLength = csvData.length;

      }

           previousPosts = posts;
      previousTitles = posts.map(post => post.Title);
      // Update the displayed posts
      displayPosts(posts);
    } catch (error) {
      console.error("Error checking for new posts:", error);
    }
  }


  // Check for new posts every 5 seconds (adjust as needed)
  setInterval(checkForNewPosts, 5000);
  checkForNewPosts()
  </script>
</body>
</html>