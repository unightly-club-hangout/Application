<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Unightly Club Hangout</title>
  <link rel="icon" href="https://raw.githubusercontent.com/silentmason/Unightly-Club-Hangout/refs/heads/main/UCHimage.webp" type="image/x-icon">

  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/airtable@0.11.6/lib/airtable.browser.min.js"></script>
</head>
<body>
  <header>
    <h1>Unightly Club Hangout</h1>
    <nav>
      <a href="">Home</a>
      <a href="about.html/">About</a>
      <a href="https://unightlyclubhangout.tawk.help/">Contact</a>
    </nav>
  </header>
  <div class="content">
    <div id="loading">
      Loading posts...
    </div>
    <div id="posts-container" style="display: none;"></div>
  </div>
  <footer>
    <a href="https://unightly-club-hangout.github.io/uch/terms_of_service.html">Terms of Service</a>
    <a href="https://unightly-club-hangout.github.io/uch/privacy_policy.html">Privacy Policy</a>
    <a href="https://unightly-club-hangout.github.io/uch/issue.html">System Status</a>
  </footer>
  <div class="discord-widget">
    <iframe src="https://discord.com/widget?id=1401631295108546590&theme=dark" width="350" height="500" allowtransparency="true" frameborder="0" ></iframe>
  </div>
  <script>
let previousPosts = [];
let previousTitles = []; // Track previous post titles
let previousLength = 0; // Keep track of the previous data length

const airtableToken = 'patiuPfgX7PCkU5iE.a7357d5812f0bed0ccb2f205bcb68140457f844dd5a72812ce3cef56be80c230'; // Replace with your Airtable Personal Access Token
const airtableBaseId = 'appk50UxYKJDXjCpW'; // Replace with your Airtable Base ID
const airtableTable = 'Posts'; // Replace with your table name
    const discordWebhookUrl = "https://discord.com/api/webhooks/1413564287489671350/b-vIZS-1RaWHvSye5q0Bv-zW_0s5kDoZaYTt_KRe4QR7L77tGV5fX9DVeEiiynfARgNH"; // Replace with your Discord Webhook URL
    // Timeout function
    const loadingTimeout = setTimeout(function() {
      document.getElementById('loading').textContent = "An error has occurred, 1.0, please contact staff in contacts or in our discord server.";
            document.getElementById('loading').style.color = "red";

    }, 180000); // 3 minutes

function displayPosts(records) {
  const postsContainer = document.getElementById("posts-container");
  postsContainer.innerHTML = "";
    records.forEach(record => {
    const postDiv = document.createElement("div");
    postDiv.innerHTML = `
          <h2>${record.get('Title')}</h2>
          <p>${record.get('Content')}</p>
          ${record.get('ImageURL') ? `<img src="${record.get('ImageURL')}" alt="${record.get('Title')}">` : ""}
        `;
    postsContainer.appendChild(postDiv);
  });
}

async function sendToDiscord(record) {
  const webhookUrl = discordWebhookUrl;

    // Check if the Discord column contains 'X' or 'Y'
    if (record.get('Discord') === "X") {
        console.log("Discord post disabled for this message.");
        return; // Prevent sending the webhook
    }

  const message = {
    embeds: [{
            title: record.get('Title'),
            description: record.get('Content'),
            image: record.get('ImageURL') ? { url: record.get('ImageURL') } : null
    }]
  };

  try {
    await fetch(webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(message)
    });
    console.log('Post sent to Discord!');
  } catch (error) {
    console.error('Error sending to Discord:', error);
  }
}


async function checkForNewPosts() {
    try {
        const response = await fetch(`https://api.airtable.com/v0/${airtableBaseId}/${airtableTable}`, {
        headers: {
                Authorization: `Bearer ${airtableToken}`
            }
      });

        const data = await response.json();

        displayPosts(data.records);

        //NEW - Check the messages and only send newest
      if (data.records.length > previousLength) {

            const newestPost = data.records[0];
        await sendToDiscord(newestPost);
             previousLength = data.records.length
      }
        document.getElementById('loading').style.display = 'none';
        document.getElementById('posts-container').style.display = 'block';
        clearTimeout(loadingTimeout);
    } catch (error) {
        console.error("Error fetching data:", error);
       document.getElementById('loading').textContent = "An error has occurred, 1.0, please contact staff at <a href='https://discord.gg/yourdiscordlink'>Discord Link</a>";
            document.getElementById('loading').style.color = "red";

    }
  }

  // Check for new posts every 5 seconds (adjust as needed)
  setInterval(checkForNewPosts, 5000);
  checkForNewPosts()
  </script>
</body>
</html>
