<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unightly Club Hangout</title>

  <!-- âœ… Google Tag Manager -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id=G-6JZ4GR0CGC'+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','G-6JZ4GR0CGC');
  </script>

  <!-- âœ… Open Graph -->
  <meta property="og:title" content="Unightly Club Hangout" />
  <meta property="og:description" content="Hangout for VRChat events, parties, and community meetups." />
  <meta property="og:image" content="https://yourdomain.com/preview.jpg" />
  <meta property="og:url" content="https://yourdomain.com/" />
  <meta property="og:type" content="website" />

  <!-- âœ… Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Unightly Club Hangout" />
  <meta name="twitter:description" content="Hangout for VRChat events, parties, and community meetups." />
  <meta name="twitter:image" content="https://yourdomain.com/preview.jpg" />

  <!-- âœ… Stylesheet -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- âœ… Google Tag Manager (noscript) -->
  <noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=G-6JZ4GR0CGC"
    height="0" width="0" style="display:none;visibility:hidden"></iframe>
  </noscript>

  <!-- âœ… Header -->
  <header class="dropshadow">
    <h1>Unightly Club Hangout</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="store.html">Store</a>
      <a href="tools.html">Tools</a>
    </nav>
  </header>

  <!-- âœ… Manual Refresh Button -->
  <button class="refresh-button" id="refresh-button">ðŸ”„ Refresh Content</button>

  <!-- âœ… Announcements Section -->
  <div id="discord-widget" class="dropshadow">
    <div id="loading-events">Loading announcements...</div>
  </div>

  <!-- âœ… Posts Section with Layout -->
  <div class="container">
    <div class="content" id="main-posts-widget">
      <div id="loading-posts">Loading posts...</div>
    </div>
  </div>

  <!-- âœ… Offline Notification -->
  <div id="offline-notification">
    <h1>Youâ€™re Offline</h1>
    <p>Check your connection and try again.</p>
  </div>

  <!-- âœ… Footer -->
  <footer>
    <p>&copy; 2025 Unightly Club Hangout</p>
    <nav>
      <a href="terms_of_service.html">Terms of Service</a>
      <a href="privacy_policy.html">Privacy Policy</a>
      <a href="system_status.html">System Status</a>
    </nav>
  </footer>

  <!-- âœ… JavaScript -->
  <script>
    const ANNOUNCEMENTS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTWHMfgoHQ33CDC9H30UMh67iQBpcBXv1s1cLH8-FQfZkW_VUsq2O0npXFmxBV7j9xkk16wWQo4tP29/pub?output=csv';
    const MAIN_POSTS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTuSjI-BjIDgQNkW7Q_Xec8iy_oybjJ2Mkw0uV06ZPKqm7hBZs8_a9JoxFNqWUZW_KWuHC57qCVSB9V/pub?output=csv';
    const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1413630048845693048/Hivus0XpBn0UZPJlTkXI7sHKcL3fE9YfDH8H4790yF4fYkn8kThChwT111Oux5BA_Zy_';
    const REFRESH_INTERVAL = 5 * 60 * 1000;

    function loadSheet(url, containerId, loadingId, type) {
      const loadingEl = document.getElementById(loadingId);
      loadingEl.style.display = 'block';

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
          return response.text();
        })
        .then(csv => {
          loadingEl.style.display = 'none';
          const data = parseCSV(csv);
          displayItems(data, containerId, type);
        })
        .catch(error => {
          loadingEl.style.display = 'none';
          console.error(`Error loading sheet for ${containerId}:`, error);
          document.getElementById('offline-notification').style.display = 'flex';
        });
    }

function parseCSV(csvData) {
  const lines = csvData.trim().split('\n');
  const headers = parseLine(lines[0]);
  const items = [];

  for (let i = 1; i < lines.length; i++) {
    const values = parseLine(lines[i]);
    const item = {};
    headers.forEach((header, index) => {
      item[header] = values[index] || '';
    });
    items.push(item);
  }

  return items;
}

function parseLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"' && line[i + 1] === '"') {
      current += '"';
      i++;
    } else if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      result.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current);
  return result.map(v => v.trim());
}


    function displayItems(items, containerId, type) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

      let hasVisible = false;

      items.forEach(item => {
        if (item.Display && item.Display.trim().toUpperCase() === 'TRUE') {
          const div = document.createElement('div');
          div.className = type === 'event' ? 'discord-event' : 'post';
          div.innerHTML = type === 'event'
            ? `
              <h3>${item.Name}</h3>
              <p>Date: ${item.Date || ''}</p>
              <p>Time: ${item.Time || ''}</p>
              <p>Description: ${item.Description || ''}</p>
              ${item.Link ? `<p><a href="${item.Link}" target="_blank">Join</a></p>` : ''}
            `
            : `
              <h2>${item.Title}</h2>
              <p>${item.Content}</p>
              ${item.Image ? `<img src="${item.Image}" alt="${item.Title}" />` : ''}
            `;
          container.appendChild(div);
          hasVisible = true;

          if (type === 'post' && item.Webhook && item.Webhook.trim().toUpperCase() === 'Y') {
            sendDiscordWebhook(item.Title, item.Content, item.Link);
          }
        }
      });

      container.style.display = hasVisible ? 'block' : 'none';
      container.style.height = hasVisible ? 'auto' : '0px';

      if (!hasVisible) {
        container.innerHTML = `<p>No upcoming items to display.</p>`;
      }
    }

    function sendDiscordWebhook(title, content, link) {
      const payload = {
        content: `ðŸ“¢ **${title}**\n${content}${link ? `\nðŸ”— ${link}` : ''}`
      };

      fetch(DISCORD_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).catch(err => console.error('Webhook failed:', err));
    }

    function refreshSheets() {
      document.getElementById('offline-notification').style.display = 'none';
      loadSheet(ANNOUNCEMENTS_URL, 'discord-widget', 'loading-events', 'event');
      loadSheet(MAIN_POSTS_URL, 'main-posts-widget', 'loading-posts', 'post');
    }

    window.onload = refreshSheets;
    setInterval(refreshSheets, REFRESH_INTERVAL);

    document.getElementById('refresh-button').addEventListener('click', () => {
      refreshSheets();
    });
  </script>
</body>
</html>
